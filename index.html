
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω —Ä–æ–∑</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --green:#22c55e;
      --badge:#facc15;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}

    .topbar{
      height:64px;background:#fff;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 18px; position:sticky; top:0; z-index:10;
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;font-size:20px;cursor:pointer}
    .brand .ico{font-size:22px}
    .rightIcons{display:flex;align-items:center;gap:14px}
    .cartBtn{
      width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
      background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;
    }
    .cartBtn span{font-size:20px}
    .editorBtn{
      padding:10px 14px;border-radius:14px;border:0;cursor:pointer;
      background:#111827;color:#fff;font-weight:700;display:flex;gap:8px;align-items:center;
    }

    .container{max-width:1180px;margin:18px auto;padding:0 16px 120px}
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0 16px;
    }
    .tab{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-weight:700;color:#111827;
      display:flex;gap:8px;align-items:center;
    }
    .tab.active{background:var(--green);border-color:var(--green);color:#fff}
    .tab .e{font-size:16px}

    .grid{
      display:grid;gap:18px;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 620px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      overflow:hidden; box-shadow: var(--shadow);
      display:flex;flex-direction:column;min-height: 420px;
    }
    .imgWrap{position:relative; height:240px; background:#eee; overflow:hidden; cursor:pointer}
    .imgWrap img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute; top:12px; right:12px;
      background:rgba(250,204,21,.95);
      padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px;
      display:flex;gap:6px;align-items:center;
    }
    .badge .star{font-size:14px}
    .cardBody{padding:14px 14px 16px;display:flex;flex-direction:column;gap:10px;flex:1}
    .title{font-weight:900;font-size:18px;margin:0;cursor:pointer}
    .desc{margin:0;color:var(--muted);line-height:1.35}
    .bottomRow{margin-top:auto;display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    .price{font-weight:900;font-size:26px}
    .addBtn{
      background:var(--green);color:#fff;border:0;border-radius:14px;
      padding:12px 14px;font-weight:900;cursor:pointer;white-space:nowrap;
    }

    /* Product page */
    .productLayout{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .productLayout{grid-template-columns:1fr;} }

    .panel{
      background:#fff;border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .panelPad{padding:16px}
    .galleryMain{height:520px;background:#eee}
    @media (max-width: 620px){ .galleryMain{height:360px;} }
    .galleryMain img{width:100%;height:100%;object-fit:cover}
    .thumbs{display:flex;gap:10px;padding:14px;background:#fff;border-top:1px solid var(--line)}
    .thumb{
      width:92px;height:72px;border-radius:14px;overflow:hidden;border:2px solid transparent;cursor:pointer;background:#eee;
    }
    .thumb.active{border-color:var(--green)}
    .thumb img{width:100%;height:100%;object-fit:cover}

    .pBadge{
      display:inline-flex;gap:8px;align-items:center;
      background:rgba(250,204,21,.25); border:1px solid rgba(250,204,21,.35);
      padding:8px 12px;border-radius:999px;font-weight:900;color:#7c5e00;
    }
    .pTitle{font-size:36px;margin:10px 0 8px;font-weight:1000;letter-spacing:-.02em}
    .pDesc{color:var(--muted);line-height:1.45;margin:0 0 16px}
    .bullets{margin:0 0 14px;padding-left:18px;color:#111827}
    .bullets li{margin:6px 0}
    .sectionTitle{font-weight:900;margin:18px 0 10px;display:flex;gap:10px;align-items:center}
    .timeGrid{display:grid;grid-template-columns: repeat(2, 1fr); gap:10px}
    @media (max-width: 620px){ .timeGrid{grid-template-columns:1fr;} }
    .timeBtn{
      padding:12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;font-weight:900;cursor:pointer;
    }
    .timeBtn.active{border-color:var(--green);box-shadow:0 0 0 3px rgba(34,197,94,.2)}
    .qtyRow{display:flex;align-items:center;gap:12px;margin:10px 0 14px}
    .qtyBtn{
      width:44px;height:44px;border-radius:14px;border:1px solid var(--line);
      background:#fff;font-size:22px;font-weight:900;cursor:pointer;
    }
    .qtyVal{min-width:24px;text-align:center;font-weight:1000;font-size:18px}
    .cta{
      background:var(--green);color:#fff;border:0;border-radius:16px;
      padding:14px 16px;font-weight:1000;font-size:16px;cursor:pointer;width:100%;
    }

    /* Bottom cart bar */
    .cartBar{
      position:fixed; left:0; right:0; bottom:0;
      background:#fff; border-top:1px solid var(--line);
      padding:12px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      z-index:20;
    }
    .cartBarLeft{display:flex;flex-direction:column;gap:4px}
    .cartLine1{font-weight:900}
    .cartLine2{font-weight:1000;font-size:22px}
    .cartLine3{color:var(--muted);font-size:13px}
    .orderBtn{
      background:#16a34a;color:#fff;border:0;border-radius:16px;
      padding:14px 16px;font-weight:1000;cursor:pointer;min-width:190px;
    }
    .orderBtn:disabled{background:#a7f3d0;color:#065f46;cursor:not-allowed}
    .status{margin:12px 0 0;color:#0f172a;white-space:pre-wrap}

    .backLink{
      display:inline-flex;gap:8px;align-items:center;color:#111827;
      font-weight:900;margin:8px 0 12px;
    }
    .backLink .arr{font-size:18px}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand" id="goHome">
      <div class="ico">üåπ</div>
      <div>–ú–∞–≥–∞–∑–∏–Ω —Ä–æ–∑</div>
    </div>

    <div class="rightIcons">
      <button class="editorBtn" type="button" onclick="alert('–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ')">
        ‚öôÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤
      </button>

      <button class="cartBtn" type="button" id="openCart">
        <span>üõí</span>
      </button>
    </div>
  </div>

  <div class="container" id="app"></div>

  <div class="cartBar">
    <div class="cartBarLeft">
      <div class="cartLine1">–ö–æ—Ä–∑–∏–Ω–∞: <span id="cartCount">0</span> —à—Ç.</div>
      <div class="cartLine2">–ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> ‚ÇΩ</div>
      <div class="cartLine3" id="buyerLine">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ...</div>
    </div>
    <button class="orderBtn" id="orderBtn" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

<script>
  // ========= –ù–ê–°–¢–†–û–ô–ö–ò =========
  const API_URL = "https://tg-miniapp-backend-production.up.railway.app";
  const API_KEY = "my_secret_key_123";

  // ========= Telegram =========
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }
  const user = tg?.initDataUnsafe?.user || null;

  const buyerText = user
    ? `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${user.first_name}${user.last_name ? " " + user.last_name : ""} (id ${user.id})`
    : "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: –ì–æ—Å—Ç—å (–Ω–µ –∏–∑ Telegram)";
  document.getElementById("buyerLine").textContent = buyerText;

  // ========= –î–ê–ù–ù–´–ï –ö–ê–¢–ê–õ–û–ì–ê =========
  const PRODUCTS = [
    {
      id: 1,
      title: '–ö—Ä–∞—Å–Ω—ã–µ —Ä–æ–∑—ã "–ö–ª–∞—Å—Å–∏–∫–∞"',
      category: "–ö—Ä–∞—Å–Ω—ã–µ",
      price: 3500,
      popular: true,
      desc: "–ë—É–∫–µ—Ç –∏–∑ 11 —Å–≤–µ–∂–∏—Ö –∫—Ä–∞—Å–Ω—ã—Ö —Ä–æ–∑ ‚Äî —Å–∏–º–≤–æ–ª —Å—Ç—Ä–∞—Å—Ç–∏ –∏ –ª—é–±–≤–∏",
      bullets: ["–°–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã","–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞","–£–ø–∞–∫–æ–≤–∫–∞ –≤ –ø–æ–¥–∞—Ä–æ—á–Ω—É—é –±—É–º–∞–≥—É","–û—Ç–∫—Ä—ã—Ç–∫–∞ —Å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤ –ø–æ–¥–∞—Ä–æ–∫"],
      images: [
        "https://images.unsplash.com/photo-1548095115-45697e1bd1b3?auto=format&fit=crop&w=1200&q=80",
        "https://images.unsplash.com/photo-1457089328109-e5d9bd499191?auto=format&fit=crop&w=900&q=80",
        "https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=900&q=80"
      ]
    },
    {
      id: 2,
      title: '–ë–µ–ª—ã–µ —Ä–æ–∑—ã "–ù–µ–∂–Ω–æ—Å—Ç—å"',
      category: "–ë–µ–ª—ã–µ",
      price: 3200,
      popular: true,
      desc: "–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –±—É–∫–µ—Ç –∏–∑ –±–µ–ª—ã—Ö —Ä–æ–∑ –¥–ª—è –æ—Å–æ–±–µ–Ω–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤",
      bullets: ["–°–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã","–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞","–ü–æ–¥–∞—Ä–æ—á–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞","–û—Ç–∫—Ä—ã—Ç–∫–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫"],
      images: [
        "https://images.unsplash.com/photo-1509042239860-f550ce710b93?auto=format&fit=crop&w=1200&q=80",
        "https://images.unsplash.com/photo-1461344577544-4e5dc9487184?auto=format&fit=crop&w=900&q=80",
        "https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=900&q=80"
      ]
    },
    {
      id: 3,
      title: '–†–æ–∑–æ–≤—ã–µ —Ä–æ–∑—ã "–†–æ–º–∞–Ω—Ç–∏–∫–∞"',
      category: "–†–æ–∑–æ–≤—ã–µ",
      price: 2900,
      popular: true,
      desc: "–ù–µ–∂–Ω—ã–π –±—É–∫–µ—Ç –∏–∑ —Ä–æ–∑–æ–≤—ã—Ö —Ä–æ–∑ ‚Äî –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏–π",
      bullets: ["–°–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã","–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞","–ü–æ–¥–∞—Ä–æ—á–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞","–û—Ç–∫—Ä—ã—Ç–∫–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫"],
      images: [
        "https://images.unsplash.com/photo-1444392061186-0e23080c310a?auto=format&fit=crop&w=1200&q=80",
        "https://images.unsplash.com/photo-1526045478516-99145907023c?auto=format&fit=crop&w=900&q=80",
        "https://images.unsplash.com/photo-1457089328109-e5d9bd499191?auto=format&fit=crop&w=900&q=80"
      ]
    }
  ];

  const DELIVERY_SLOTS = ["10:00 - 12:00","12:00 - 14:00","14:00 - 16:00","16:00 - 18:00","18:00 - 20:00"];

  // ========= STATE =========
  const cart = new Map();     // productId -> qty
  const delivery = new Map(); // productId -> slot
  const app = document.getElementById("app");
  const cartCountEl = document.getElementById("cartCount");
  const cartTotalEl = document.getElementById("cartTotal");
  const orderBtn = document.getElementById("orderBtn");

  function money(n){ return String(n); }
  function getQty(id){ return cart.get(id) || 0; }
  function setQty(id, qty){
    if (qty <= 0) cart.delete(id);
    else cart.set(id, qty);
    updateCartUI();
  }

  function calcTotals(){
    let count = 0, total = 0;
    for (const p of PRODUCTS){
      const q = getQty(p.id);
      if (q>0){ count += q; total += q*p.price; }
    }
    return {count,total};
  }

  function updateCartUI(){
    const {count,total} = calcTotals();
    cartCountEl.textContent = count;
    cartTotalEl.textContent = money(total);
    orderBtn.disabled = count === 0;
  }

  // ========= ROUTER (/#/product/1) =========
  function go(path){ location.hash = path; }
  function currentRoute(){ return location.hash.replace("#","") || "/"; }

  function render(){
    const route = currentRoute();
    if (route.startsWith("/product/")){
      const id = Number(route.split("/")[2]);
      renderProduct(id);
      return;
    }
    renderCatalog();
  }

  // ========= CATALOG VIEW =========
  let activeTab = "–í—Å–µ —Ä–æ–∑—ã";

  const tabs = [
    {label:"–í—Å–µ —Ä–æ–∑—ã", emoji:"üåπ"},
    {label:"–ö—Ä–∞—Å–Ω—ã–µ", emoji:"üíñ"},
    {label:"–ë–µ–ª—ã–µ", emoji:"ü§ç"},
    {label:"–†–æ–∑–æ–≤—ã–µ", emoji:"üíó"},
    {label:"–ñ—ë–ª—Ç—ã–µ", emoji:"üíõ"},
    {label:"–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ", emoji:"‚≠ê"}
  ];

  function filteredProducts(){
    if (activeTab === "–í—Å–µ —Ä–æ–∑—ã") return PRODUCTS;
    if (activeTab === "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ") return PRODUCTS.filter(p=>p.popular);
    return PRODUCTS.filter(p=>p.category===activeTab);
  }

  function renderCatalog(){
    const items = filteredProducts();

    app.innerHTML = `
      <div class="tabs" id="tabs"></div>
      <div class="grid" id="grid"></div>
      <div class="status" id="status"></div>
    `;

    const tabsEl = document.getElementById("tabs");
    tabs.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tab" + (t.label===activeTab ? " active" : "");
      b.innerHTML = `<span class="e">${t.emoji}</span> ${t.label}`;
      b.onclick = ()=>{ activeTab = t.label; render(); };
      tabsEl.appendChild(b);
    });

    const grid = document.getElementById("grid");
    items.forEach(p=>{
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="imgWrap">
          <img src="${p.images[0]}" alt="">
          ${p.popular ? `<div class="badge"><span class="star">‚≠ê</span> –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</div>` : ""}
        </div>
        <div class="cardBody">
          <p class="title">${p.title}</p>
          <p class="desc">${p.desc}</p>
          <div class="bottomRow">
            <div class="price">${money(p.price)} ‚ÇΩ</div>
            <button class="addBtn">+ –í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `;
      card.querySelector(".imgWrap").onclick = ()=>go(`/product/${p.id}`);
      card.querySelector(".title").onclick = ()=>go(`/product/${p.id}`);
      card.querySelector(".addBtn").onclick = (e)=>{
        e.stopPropagation();
        setQty(p.id, getQty(p.id)+1);
      };
      grid.appendChild(card);
    });
  }

  // ========= PRODUCT VIEW =========
  function renderProduct(id){
    const p = PRODUCTS.find(x=>x.id===id);
    if (!p){ go("/"); return; }

    const slot = delivery.get(id) || "";

    app.innerHTML = `
      <a class="backLink" href="javascript:void(0)" id="back"><span class="arr">‚Üê</span> –ù–∞–∑–∞–¥</a>
      <div class="productLayout">
        <div class="panel">
          <div class="galleryMain" id="mainImg"></div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <div class="panel">
          <div class="panelPad">
            ${p.popular ? `<div class="pBadge">‚≠ê –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</div>` : ""}
            <div class="pTitle">${p.title}</div>
            <p class="pDesc">${p.desc}</p>

            <div class="sectionTitle">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</div>
            <ul class="bullets">
              ${p.bullets.map(b=>`<li>${b}</li>`).join("")}
            </ul>

            <div class="sectionTitle">üïí –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:</div>
            <div class="timeGrid" id="slots"></div>

            <div class="price" style="margin:18px 0 8px;color:var(--green)">${money(p.price)} ‚ÇΩ</div>

            <div class="sectionTitle">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</div>
            <div class="qtyRow">
              <button class="qtyBtn" id="minus">‚àí</button>
              <div class="qtyVal" id="qtyVal">${getQty(id)}</div>
              <button class="qtyBtn" id="plus">+</button>
            </div>

            <button class="cta" id="addToCart">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            <div class="status" id="status"></div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("back").onclick = ()=>go("/");

    let activeImg = 0;
    const mainImg = document.getElementById("mainImg");
    function drawMain(){ mainImg.innerHTML = `<img src="${p.images[activeImg]}" alt="">`; }
    const thumbs = document.getElementById("thumbs");
    p.images.forEach((src, idx)=>{
      const t = document.createElement("div");
      t.className = "thumb" + (idx===activeImg ? " active" : "");
      t.innerHTML = `<img src="${src}" alt="">`;
      t.onclick = ()=>{
        activeImg = idx;
        [...thumbs.children].forEach(ch=>ch.classList.remove("active"));
        t.classList.add("active");
        drawMain();
      };
      thumbs.appendChild(t);
    });
    drawMain();

    const slots = document.getElementById("slots");
    DELIVERY_SLOTS.forEach(s=>{
      const b = document.createElement("button");
      b.className = "timeBtn" + (s===slot ? " active" : "");
      b.textContent = s;
      b.onclick = ()=>{
        delivery.set(id, s);
        [...slots.children].forEach(ch=>ch.classList.remove("active"));
        b.classList.add("active");
      };
      slots.appendChild(b);
    });

    const qtyVal = document.getElementById("qtyVal");
    document.getElementById("minus").onclick = ()=>{ setQty(id, getQty(id)-1); qtyVal.textContent = getQty(id); };
    document.getElementById("plus").onclick = ()=>{ setQty(id, getQty(id)+1); qtyVal.textContent = getQty(id); };

    document.getElementById("addToCart").onclick = ()=>{
      if (getQty(id) === 0) setQty(id, 1);
      qtyVal.textContent = getQty(id);
      const st = document.getElementById("status");
      st.textContent = "–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ";
      setTimeout(()=>st.textContent="", 900);
    };
  }

  // ========= ORDER (–í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å /api/order) =========
  function buildOrderText(){
    const lines = [];
    lines.push("üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑");

    if (user){
      const name = `${user.first_name}${user.last_name ? " " + user.last_name : ""}`;
      lines.push(`üë§ ${name}`);
      lines.push(`üÜî ${user.id}`);
      if (user.username) lines.push(`üîó @${user.username}`);
    } else {
      lines.push("üë§ –ì–æ—Å—Ç—å (–Ω–µ –∏–∑ Telegram)");
    }

    lines.push("");
    lines.push("–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:");

    let total = 0;
    for (const p of PRODUCTS){
      const q = getQty(p.id);
      if (q>0){
        const sum = q*p.price;
        total += sum;
        const slot = delivery.get(p.id) || "–Ω–µ –≤—ã–±—Ä–∞–Ω–æ";
        lines.push(`‚Ä¢ ${p.title} ‚Äî ${q} —à—Ç √ó ${p.price} ‚ÇΩ = ${sum} ‚ÇΩ`);
        lines.push(`  üïí –î–æ—Å—Ç–∞–≤–∫–∞: ${slot}`);
      }
    }
    lines.push("");
    lines.push(`–ò–¢–û–ì–û: ${total} ‚ÇΩ`);
    return lines.join("\n");
  }

  async function sendOrder(){
    const {count} = calcTotals();
    if (count === 0) return;

    // buyer_id –±–µ—Ä—ë–º –∏–∑ Telegram
    const buyerId = user?.id || 0;
    if (!buyerId) {
      alert("–û—Ç–∫—Ä–æ–π mini-app –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.");
      return;
    }

    orderBtn.disabled = true;

    const orderText = buildOrderText();

    try{
      const r = await fetch(`${API_URL}/api/order`, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-API-Key": API_KEY
        },
        body: JSON.stringify({
          text: orderText,
          buyer_id: buyerId
        })
      });

      const data = await r.json().catch(()=> ({}));
      if (!r.ok){
        alert("–û—à–∏–±–∫–∞: " + JSON.stringify(data));
        orderBtn.disabled = false;
        return;
      }

      // –æ—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
      cart.clear();
      delivery.clear();
      updateCartUI();

      if (tg) tg.showAlert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ");
      else alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ");

      go("/");
    } catch(e){
      alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + e);
      orderBtn.disabled = false;
    }
  }

  orderBtn.onclick = sendOrder;

  // header handlers
  document.getElementById("goHome").onclick = ()=>go("/");
  document.getElementById("openCart").onclick = ()=>{
    const {count} = calcTotals();
    if (count===0) alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è");
    else alert(buildOrderText());
  };

  window.addEventListener("hashchange", render);
  updateCartUI();
  render();
</script>
</body>
</html>
