<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω —Ä–æ–∑</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--green:#22c55e;--shadow:0 10px 25px rgba(15,23,42,.08);--radius:18px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .topbar{height:64px;background:#fff;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0}
    .brand{font-weight:900;font-size:20px;display:flex;gap:10px;align-items:center}
    .container{padding:16px 16px 120px;max-width:820px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
    .title{font-weight:900;font-size:18px;margin:0 0 6px}
    .desc{color:var(--muted);margin:0 0 10px;line-height:1.35}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .price{font-weight:900;font-size:22px}
    .btn{background:var(--green);color:#fff;border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer;white-space:nowrap}
    .cartBar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .orderBtn{background:#16a34a;color:#fff;border:0;border-radius:16px;padding:14px 16px;font-weight:1000;cursor:pointer;min-width:180px}
    .orderBtn:disabled{background:#a7f3d0;color:#065f46;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">üåπ <span>–ú–∞–≥–∞–∑–∏–Ω —Ä–æ–∑</span></div>
    <div class="small" id="buyerLine">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ...</div>
  </div>

  <div class="container" id="app"></div>

  <div class="cartBar">
    <div>
      <div>–ö–æ—Ä–∑–∏–Ω–∞: <b id="cartCount">0</b> —à—Ç.</div>
      <div>–ò—Ç–æ–≥–æ: <b id="cartTotal">0</b> ‚ÇΩ</div>
    </div>
    <button class="orderBtn" id="orderBtn" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

<script>
  // ‚úÖ same-origin -> Vercel -> rewrite -> Railway
  const ORDER_ENDPOINT = "/api/order";

  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }
  const user = tg?.initDataUnsafe?.user || null;

  document.getElementById("buyerLine").textContent = user
    ? `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${user.first_name}${user.last_name ? " " + user.last_name : ""} (id ${user.id})`
    : `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: –≥–æ—Å—Ç—å (–æ—Ç–∫—Ä–æ–π –≤ Telegram)`;

  const PRODUCTS = [
    { id: 1, title: '–ö—Ä–∞—Å–Ω—ã–µ —Ä–æ–∑—ã "–ö–ª–∞—Å—Å–∏–∫–∞"', desc: "–ë—É–∫–µ—Ç –∏–∑ 11 —Å–≤–µ–∂–∏—Ö –∫—Ä–∞—Å–Ω—ã—Ö —Ä–æ–∑ ‚Äî —Å–∏–º–≤–æ–ª —Å—Ç—Ä–∞—Å—Ç–∏ –∏ –ª—é–±–≤–∏", price: 3500 },
    { id: 2, title: '–ë–µ–ª—ã–µ —Ä–æ–∑—ã "–ù–µ–∂–Ω–æ—Å—Ç—å"', desc: "–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –±—É–∫–µ—Ç –∏–∑ –±–µ–ª—ã—Ö —Ä–æ–∑ –¥–ª—è –æ—Å–æ–±–µ–Ω–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤", price: 3200 },
    { id: 3, title: '–†–æ–∑–æ–≤—ã–µ —Ä–æ–∑—ã "–†–æ–º–∞–Ω—Ç–∏–∫–∞"', desc: "–ù–µ–∂–Ω—ã–π –±—É–∫–µ—Ç –∏–∑ —Ä–æ–∑–æ–≤—ã—Ö —Ä–æ–∑ ‚Äî –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏–π", price: 2900 }
  ];

  const cart = new Map();

  const app = document.getElementById("app");
  const cartCountEl = document.getElementById("cartCount");
  const cartTotalEl = document.getElementById("cartTotal");
  const orderBtn = document.getElementById("orderBtn");

  function render() {
    app.innerHTML = "";
    PRODUCTS.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="title">${p.title}</div>
        <div class="desc">${p.desc}</div>
        <div class="row">
          <div class="price">${p.price} ‚ÇΩ</div>
          <button class="btn">+ –í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
      `;
      card.querySelector("button").onclick = () => {
        cart.set(p.id, (cart.get(p.id) || 0) + 1);
        updateCart();
      };
      app.appendChild(card);
    });
  }

  function updateCart() {
    let count = 0, total = 0;
    PRODUCTS.forEach(p => {
      const q = cart.get(p.id) || 0;
      count += q;
      total += q * p.price;
    });
    cartCountEl.textContent = count;
    cartTotalEl.textContent = total;
    orderBtn.disabled = count === 0;
  }

  function buildOrderText() {
    const lines = [];
    lines.push("üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑");

    if (user) {
      const name = `${user.first_name}${user.last_name ? " " + user.last_name : ""}`;
      lines.push(`üë§ ${name}`);
      lines.push(`üÜî ${user.id}`);
      if (user.username) lines.push(`üîó @${user.username}`);
    }

    lines.push("");
    lines.push("–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:");

    let total = 0;
    PRODUCTS.forEach(p => {
      const q = cart.get(p.id) || 0;
      if (q > 0) {
        const sum = q * p.price;
        total += sum;
        lines.push(`‚Ä¢ ${p.title} ‚Äî ${q} √ó ${p.price} ‚ÇΩ = ${sum} ‚ÇΩ`);
      }
    });

    lines.push("");
    lines.push(`–ò–¢–û–ì–û: ${total} ‚ÇΩ`);
    return lines.join("\n");
  }

  async function sendOrder() {
    if (!user?.id) {
      alert("–û—Ç–∫—Ä–æ–π –º–∞–≥–∞–∑–∏–Ω –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.");
      return;
    }

    orderBtn.disabled = true;

    try {
      const r = await fetch(ORDER_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: buildOrderText(),
          buyer_id: user.id
        })
      });

      const raw = await r.text();

      if (!r.ok) {
        alert(`–û—à–∏–±–∫–∞ ${r.status}:\n${raw}`);
        orderBtn.disabled = false;
        return;
      }

      // —É—Å–ø–µ—Ö
      cart.clear();
      updateCart();

      if (tg) tg.showAlert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ");
      else alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ");

    } catch (e) {
      alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:\n" + e);
      orderBtn.disabled = false;
    }
  }

  orderBtn.onclick = sendOrder;

  render();
  updateCart();
</script>
</body>
</html>
