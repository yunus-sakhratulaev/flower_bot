<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini App Test</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    button { padding: 12px 16px; font-size: 16px; cursor: pointer; }
    textarea { width: 100%; height: 120px; margin-top: 12px; font-size: 14px; }
    .row { margin-top: 12px; }
    .status { margin-top: 12px; white-space: pre-wrap; }
  </style>
</head>

<body>
  <h2>Mini App ‚Üí Bot ‚Üí Group</h2>

  <div class="row">
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</button>
  </div>

  <div class="row">
    <textarea id="text" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)"></textarea>
  </div>

  <div class="status" id="status"></div>

  <script>
    // ‚úÖ –í–°–¢–ê–í–¨ —Å—é–¥–∞ —Ç–≤–æ–π Railway –¥–æ–º–µ–Ω
    const API_URL = "https://tg-miniapp-backend-production.up.railway.app";
    // ‚úÖ –¢–≤–æ–π API_KEY (–∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª–æ–∂–∏–ª –≤ Railway Variables)
    const API_KEY = "lfdfq";

    const statusEl = document.getElementById("status");
    const textEl = document.getElementById("text");

    function log(msg) {
      statusEl.textContent = msg;
    }

    // Telegram WebApp (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω—É—Ç—Ä–∏ Telegram)
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    function buildMessage() {
      const customText = (textEl.value || "").trim();

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª —Ç–µ–∫—Å—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (customText) return customText;

      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ Telegram ‚Äî –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞
      const user = tg?.initDataUnsafe?.user;
      if (user) {
        const name = [user.first_name, user.last_name].filter(Boolean).join(" ");
        return `‚úÖ –¢–µ—Å—Ç –∏–∑ mini-app\nüë§ ${name}\nüÜî ${user.id}`;
      }

      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –ø—Ä–æ—Å—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
      return "‚úÖ –¢–µ—Å—Ç –∏–∑ mini-app (–æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ Telegram)";
    }

    async function sendToGroup() {
      try {
        log("–û—Ç–ø—Ä–∞–≤–ª—è—é...");

        const text = buildMessage();

        const r = await fetch(`${API_URL}/api/send`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-API-Key": API_KEY
          },
          body: JSON.stringify({ text })
        });

        const data = await r.json().catch(() => ({}));

        if (!r.ok) {
          log("–û—à–∏–±–∫–∞:\n" + JSON.stringify(data, null, 2));
          return;
        }

        log("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ\n" + JSON.stringify(data, null, 2));

        // –ï—Å–ª–∏ –≤ Telegram ‚Äî –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (tg) tg.showAlert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥—Ä—É–ø–ø—É ‚úÖ");

      } catch (e) {
        log("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:\n" + String(e));
      }
    }

    document.getElementById("sendBtn").addEventListener("click", sendToGroup);
  </script>
</body>
</html>
