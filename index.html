<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 16px; margin: 0; }
    h1 { margin: 0 0 10px; font-size: 22px; }
    .sub { color: #666; margin: 0 0 16px; font-size: 14px; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 520px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card {
      border: 1px solid #e6e6e6; border-radius: 12px; padding: 12px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.04);
      display: flex; gap: 12px; align-items: center;
      background: #fff;
    }
    .img {
      width: 64px; height: 64px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-size: 28px; background: #f3f3f3; flex: 0 0 auto;
    }
    .title { font-weight: 700; margin: 0; font-size: 16px; }
    .price { margin: 6px 0 10px; color: #111; }
    .muted { color:#666; font-size: 12px; margin-top: 2px; }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button {
      border: 0; border-radius: 10px; padding: 10px 12px;
      cursor: pointer; font-weight: 700;
    }
    .btnAdd { background: #111; color: #fff; }
    .btnMinus { background: #eee; }
    .qty { min-width: 34px; text-align: center; font-weight: 700; }

    .cart {
      position: sticky; bottom: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.95);
      border-top: 1px solid #eee;
      padding: 12px 16px;
      display: flex; gap: 12px; align-items: center; justify-content: space-between;
      backdrop-filter: blur(8px);
    }
    .cartInfo { font-size: 14px; }
    .total { font-weight: 800; font-size: 16px; }
    .btnOrder { background: #1a73e8; color: #fff; padding: 12px 14px; }
    .btnOrder:disabled { background: #a9c6f7; cursor: not-allowed; }

    .status { margin-top: 10px; white-space: pre-wrap; font-size: 13px; color: #333; }
  </style>
</head>

<body>
  <h1>–ö–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤</h1>
  <p class="sub">–í—ã–±–µ—Ä–∏—Ç–µ –±—É–∫–µ—Ç/—Ü–≤–µ—Ç—ã, –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑¬ª.</p>

  <div id="grid" class="grid"></div>

  <div class="cart">
    <div class="cartInfo">
      <div><b>–ö–æ—Ä–∑–∏–Ω–∞:</b> <span id="cartCount">0</span> —à—Ç.</div>
      <div class="total">–ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> ‚ÇΩ</div>
      <div class="muted" id="who"></div>
    </div>
    <div>
      <button id="orderBtn" class="btnOrder" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </div>

  <div class="status" id="status"></div>

<script>
  // ‚úÖ –¢–í–û–ô BACKEND –ù–ê RAILWAY
  const API_URL = "https://tg-miniapp-backend-production.up.railway.app";
  // ‚úÖ –¢–í–û–ô API_KEY (–∫–∞–∫ –≤ Railway Variables)
  const API_KEY = "my_secret_key_123";

  // –ö–∞—Ç–∞–ª–æ–≥ (–º–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å –∫–∞–∫ —Ö–æ—á–µ—à—å)
  const catalog = [
    { id: "rose_red_11", name: "11 –∫—Ä–∞—Å–Ω—ã—Ö —Ä–æ–∑", price: 2500, emoji: "üåπ", note: "–ö–ª–∞—Å—Å–∏–∫–∞" },
    { id: "tulip_mix_15", name: "15 —Ç—é–ª—å–ø–∞–Ω–æ–≤ –º–∏–∫—Å", price: 1900, emoji: "üå∑", note: "–Ø—Ä–∫–æ –∏ –Ω–µ–∂–Ω–æ" },
    { id: "peony_7", name: "7 –ø–∏–æ–Ω–æ–≤", price: 3200, emoji: "üå∏", note: "–°–µ–∑–æ–Ω–Ω—ã–π —Ö–∏—Ç" },
    { id: "chamomile", name: "–†–æ–º–∞—à–∫–∏ (–±—É–∫–µ—Ç)", price: 1500, emoji: "üåº", note: "–õ—ë–≥–∫–∏–π –±—É–∫–µ—Ç" },
    { id: "orchid", name: "–û—Ä—Ö–∏–¥–µ—è –≤ –≥–æ—Ä—à–∫–µ", price: 2800, emoji: "ü™¥", note: "–î–æ–ª–≥–æ —Ä–∞–¥—É–µ—Ç" },
    { id: "gift_box", name: "–ü–æ–¥–∞—Ä–æ—á–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞", price: 800, emoji: "üéÅ", note: "–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" },
  ];

  const cart = new Map(); // id -> qty

  const grid = document.getElementById("grid");
  const cartCountEl = document.getElementById("cartCount");
  const cartTotalEl = document.getElementById("cartTotal");
  const orderBtn = document.getElementById("orderBtn");
  const statusEl = document.getElementById("status");
  const whoEl = document.getElementById("who");

  // Telegram WebApp context
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  const user = tg?.initDataUnsafe?.user;
  const whoText = user
    ? `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${user.first_name}${user.last_name ? " " + user.last_name : ""} (id ${user.id})`
    : "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: –ì–æ—Å—Ç—å (–Ω–µ –∏–∑ Telegram)";
  whoEl.textContent = whoText;

  function money(n) { return String(n); }

  function getQty(id) { return cart.get(id) || 0; }

  function setQty(id, qty) {
    if (qty <= 0) cart.delete(id);
    else cart.set(id, qty);
    render();
  }

  function calcTotals() {
    let count = 0, total = 0;
    for (const item of catalog) {
      const qty = getQty(item.id);
      if (qty > 0) {
        count += qty;
        total += qty * item.price;
      }
    }
    return { count, total };
  }

  function render() {
    grid.innerHTML = "";

    for (const item of catalog) {
      const qty = getQty(item.id);

      const card = document.createElement("div");
      card.className = "card";

      const img = document.createElement("div");
      img.className = "img";
      img.textContent = item.emoji;

      const body = document.createElement("div");
      body.style.flex = "1 1 auto";

      const title = document.createElement("p");
      title.className = "title";
      title.textContent = item.name;

      const price = document.createElement("div");
      price.className = "price";
      price.innerHTML = `<b>${money(item.price)} ‚ÇΩ</b> <span class="muted">/ —à—Ç.</span>`;

      const note = document.createElement("div");
      note.className = "muted";
      note.textContent = item.note || "";

      const row = document.createElement("div");
      row.className = "row";

      const minus = document.createElement("button");
      minus.className = "btnMinus";
      minus.textContent = "‚àí";
      minus.onclick = () => setQty(item.id, qty - 1);

      const qtyEl = document.createElement("div");
      qtyEl.className = "qty";
      qtyEl.textContent = qty;

      const add = document.createElement("button");
      add.className = "btnAdd";
      add.textContent = "–î–æ–±–∞–≤–∏—Ç—å";
      add.onclick = () => setQty(item.id, qty + 1);

      row.appendChild(minus);
      row.appendChild(qtyEl);
      row.appendChild(add);

      body.appendChild(title);
      body.appendChild(price);
      body.appendChild(note);
      body.appendChild(row);

      card.appendChild(img);
      card.appendChild(body);
      grid.appendChild(card);
    }

    const { count, total } = calcTotals();
    cartCountEl.textContent = count;
    cartTotalEl.textContent = money(total);

    orderBtn.disabled = count === 0;
  }

  function buildOrderText() {
    const lines = [];
    lines.push("üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑");

    if (user) {
      const name = `${user.first_name}${user.last_name ? " " + user.last_name : ""}`;
      lines.push(`üë§ ${name}`);
      lines.push(`üÜî ${user.id}`);
      if (user.username) lines.push(`üîó @${user.username}`);
    } else {
      lines.push("üë§ –ì–æ—Å—Ç—å (–Ω–µ –∏–∑ Telegram)");
    }

    lines.push("");
    lines.push("–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:");

    let total = 0;
    for (const item of catalog) {
      const qty = getQty(item.id);
      if (qty > 0) {
        const sum = qty * item.price;
        total += sum;
        lines.push(`‚Ä¢ ${item.name} ‚Äî ${qty} —à—Ç √ó ${item.price} ‚ÇΩ = ${sum} ‚ÇΩ`);
      }
    }

    lines.push("");
    lines.push(`–ò–¢–û–ì–û: ${total} ‚ÇΩ`);

    return lines.join("\n");
  }

  async function sendOrder() {
    statusEl.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–∫–∞–∑...";

    const text = buildOrderText();

    try {
      const r = await fetch(`${API_URL}/api/send`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": API_KEY
        },
        body: JSON.stringify({ text })
      });

      const data = await r.json().catch(() => ({}));

      if (!r.ok) {
        statusEl.textContent = "–û—à–∏–±–∫–∞:\n" + JSON.stringify(data, null, 2);
        return;
      }

      statusEl.textContent = "–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ";

      // –ú–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
      cart.clear();
      render();

      if (tg) tg.showAlert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É ‚úÖ");

    } catch (e) {
      statusEl.textContent = "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:\n" + String(e);
    }
  }

  orderBtn.addEventListener("click", sendOrder);

  render();
</script>
</body>
</html>
