<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>FlowerShop</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background:#fafafa; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; margin-bottom:12px; }
    .btn { width:100%; padding:14px; border:none; border-radius:10px; background:#e83e8c; color:#fff; font-weight:700; font-size:16px; }
    .btn:disabled { opacity:.6 }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { padding:10px 12px; border:1px solid #ddd; border-radius:999px; cursor:pointer; background:#fff; }
    .pill.active { border-color:#e83e8c; background:#fff0f6; }
    input { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; }
    .small { color:#666; font-size:12px; margin-top:8px; }
    code { background:#f2f2f2; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card" id="dbg"></div>

  <div class="card">
    <h3>üíê –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –±—É–∫–µ—Ç</h3>
    <p>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: <b id="basePrice">3500</b> ‚ÇΩ</p>

    <p><b>–¶–≤–µ—Ç:</b></p>
    <div class="row" id="colors"></div>

    <p style="margin-top:12px;"><b>–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</b></p>
    <div class="row" id="addons"></div>

    <p style="margin-top:12px;"><b>–î–æ—Å—Ç–∞–≤–∫–∞:</b></p>
    <div class="row" id="delivery"></div>

    <p style="margin-top:12px;"><b>–ü—Ä–æ–º–æ–∫–æ–¥:</b></p>
    <input id="promo" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: flower2024" />

    <p style="margin-top:12px;"><b>–ò—Ç–æ–≥–æ:</b> <span id="total">5000</span> ‚ÇΩ</p>

    <button class="btn" id="sendBtn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <div class="small">–í–∞–∂–Ω–æ: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App.</div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;

    // ====== DEBUG PANEL ======
    const dbg = document.getElementById("dbg");
    const initDataLen = (tg?.initData || "").length;
    dbg.innerHTML = `
      <b>Debug</b><br>
      WebApp: <code>${!!tg}</code><br>
      initData length: <code>${initDataLen}</code><br>
      –ï—Å–ª–∏ initData length = 0 ‚Äî —Ç—ã –æ—Ç–∫—Ä—ã–ª —Å–∞–π—Ç –ù–ï —á–µ—Ä–µ–∑ Telegram MiniApp.
    `;

    if (tg) {
      tg.expand();
      tg.ready();
    }

    // ====== DATA ======
    const basePrice = 3500;
    let selectedColor = "#e83e8c";
    let selectedAddons = [];
    let deliveryType = "center";
    let deliveryPrice = 1500;

    const colorList = [
      ["–†–æ–∑–æ–≤—ã–π", "#e83e8c"],
      ["–ì–æ–ª—É–±–æ–π", "#3498db"],
      ["–ó–µ–ª—ë–Ω—ã–π", "#2ecc71"],
      ["–û—Ä–∞–Ω–∂–µ–≤—ã–π", "#f39c12"]
    ];

    const addonList = [
      ["üß∏ –ú–∏—à–∫–∞", 1000],
      ["üç¨ –ö–æ–Ω—Ñ–µ—Ç—ã", 300],
      ["üç´ –®–æ–∫–æ–ª–∞–¥", 500]
    ];

    const deliveryList = [
      ["–¶–µ–Ω—Ç—Ä", "center", 1500],
      ["–î–æ –ú–ö–ê–î", "mkad", 2000],
      ["–°–∞–º–æ–≤—ã–≤–æ–∑", "self", 0],
      ["–ó–∞ –ú–ö–ê–î", "beyond_mkad", 0]
    ];

    // ====== RENDER ======
    const colorsEl = document.getElementById("colors");
    const addonsEl = document.getElementById("addons");
    const deliveryEl = document.getElementById("delivery");
    const promoEl = document.getElementById("promo");
    const totalEl = document.getElementById("total");
    const sendBtn = document.getElementById("sendBtn");

    function pill(text, onClick) {
      const el = document.createElement("div");
      el.className = "pill";
      el.textContent = text;
      el.addEventListener("click", onClick);
      return el;
    }

    function render() {
      colorsEl.innerHTML = "";
      colorList.forEach(([name, hex]) => {
        const el = pill(name, () => {
          selectedColor = hex;
          render();
        });
        if (selectedColor === hex) el.classList.add("active");
        colorsEl.appendChild(el);
      });

      addonsEl.innerHTML = "";
      addonList.forEach(([name, price]) => {
        const key = `${name} (+${price}‚ÇΩ)`;
        const el = pill(key, () => {
          const idx = selectedAddons.findIndex(x => x.name === name);
          if (idx === -1) selectedAddons.push({ name, price });
          else selectedAddons.splice(idx, 1);
          render();
        });
        if (selectedAddons.some(x => x.name === name)) el.classList.add("active");
        addonsEl.appendChild(el);
      });

      deliveryEl.innerHTML = "";
      deliveryList.forEach(([label, type, price]) => {
        const el = pill(`${label} (${price}‚ÇΩ)`, () => {
          deliveryType = type;
          deliveryPrice = price;
          render();
        });
        if (deliveryType === type) el.classList.add("active");
        deliveryEl.appendChild(el);
      });

      updateTotal();
    }

    function updateTotal() {
      let total = basePrice + deliveryPrice + selectedAddons.reduce((s, x) => s + x.price, 0);
      const promo = (promoEl.value || "").trim().toLowerCase();
      if (promo === "flower2024") total = Math.round(total * 0.9);
      if (promo === "newyear") total = Math.round(total * 0.85);
      totalEl.textContent = total;
    }

    promoEl.addEventListener("input", updateTotal);

    // ====== SEND ======
    sendBtn.addEventListener("click", () => {
      const promo = (promoEl.value || "").trim();
      const orderData = {
        bouquet: "romantic",
        color: selectedColor,
        add_ons: selectedAddons.map(x => `${x.name} (+${x.price}‚ÇΩ)`),
        total_price: Number(totalEl.textContent || 0),
        promo_code: promo,
        delivery_type: deliveryType,
        delivery_price: deliveryPrice
      };

      sendBtn.disabled = true;
      sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶";

      try {
        if (!tg) {
          alert("–û—Ç–∫—Ä–æ–π —Å–∞–π—Ç –≤–Ω—É—Ç—Ä–∏ Telegram Mini App. –°–µ–π—á–∞—Å tg = null");
          sendBtn.disabled = false;
          sendBtn.textContent = "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑";
          return;
        }

        tg.sendData(JSON.stringify(orderData));
        setTimeout(() => tg.close(), 600);
      } catch (e) {
        alert("sendData error: " + e);
        sendBtn.disabled = false;
        sendBtn.textContent = "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑";
      }
    });

    render();
  </script>
</body>
</html>
