<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω —Ä–æ–∑</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --green:#22c55e; --badge:#facc15;
      --shadow: 0 10px 25px rgba(15,23,42,.08); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .topbar{
      height:64px;background:#fff;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 18px; position:sticky; top:0; z-index:10;
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;font-size:20px;cursor:pointer}
    .brand .ico{font-size:22px}
    .rightIcons{display:flex;align-items:center;gap:14px}
    .cartBtn{
      width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
      background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;
    }
    .cartBtn span{font-size:20px}
    .container{max-width:1180px;margin:18px auto;padding:0 16px 170px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0 16px;}
    .tab{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-weight:700;color:#111827;
      display:flex;gap:8px;align-items:center;
    }
    .tab.active{background:var(--green);border-color:var(--green);color:#fff}
    .grid{display:grid;gap:18px;grid-template-columns: repeat(3, 1fr);}
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 620px){ .grid{grid-template-columns: 1fr;} }
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      overflow:hidden; box-shadow: var(--shadow);
      display:flex;flex-direction:column;min-height: 420px;
    }
    .imgWrap{position:relative; height:240px; background:#eee; overflow:hidden}
    .imgWrap img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute; top:12px; right:12px;
      background:rgba(250,204,21,.95);
      padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px;
      display:flex;gap:6px;align-items:center;
    }
    .cardBody{padding:14px 14px 16px;display:flex;flex-direction:column;gap:10px;flex:1}
    .title{font-weight:900;font-size:18px;margin:0}
    .desc{margin:0;color:var(--muted);line-height:1.35}
    .bottomRow{margin-top:auto;display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    .price{font-weight:900;font-size:26px}
    .addBtn{
      background:var(--green);color:#fff;border:0;border-radius:14px;
      padding:12px 14px;font-weight:900;cursor:pointer;white-space:nowrap;
    }

    .cartBar{
      position:fixed; left:0; right:0; bottom:0;
      background:#fff; border-top:1px solid var(--line);
      padding:12px 16px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px;
      z-index:20;
      flex-wrap:wrap;
    }
    .cartBarLeft{display:flex;flex-direction:column;gap:6px; min-width: 220px;}
    .cartLine1{font-weight:900}
    .cartLine2{font-weight:1000;font-size:22px}
    .cartLine3{color:var(--muted);font-size:13px}

    .addressWrap{display:flex;flex-direction:column;gap:6px;flex:1;max-width:520px;}
    .addressLabel{font-weight:900;}
    .addressInput{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }

    .orderBtn{
      background:#16a34a;color:#fff;border:0;border-radius:16px;
      padding:14px 16px;font-weight:1000;cursor:pointer;min-width:190px;
    }
    .orderBtn:disabled{background:#a7f3d0;color:#065f46;cursor:not-allowed}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand" id="goHome">
      <div class="ico">üåπ</div>
      <div>–ú–∞–≥–∞–∑–∏–Ω —Ä–æ–∑</div>
    </div>

    <div class="rightIcons">
      <button class="cartBtn" type="button" id="openCart"><span>üõí</span></button>
    </div>
  </div>

  <div class="container" id="app"></div>

  <div class="cartBar">
    <div class="cartBarLeft">
      <div class="cartLine1">–ö–æ—Ä–∑–∏–Ω–∞: <span id="cartCount">0</span> —à—Ç.</div>
      <div class="cartLine2">–ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> ‚ÇΩ</div>
      <div class="cartLine3" id="buyerLine">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ...</div>
    </div>

    <div class="addressWrap">
      <div class="addressLabel">–ê–¥—Ä–µ—Å</div>
      <input class="addressInput" id="addressInput" placeholder="—É–ª. –ü—É—à–∫–∏–Ω–∞ 10, –ø–æ–¥—ä–µ–∑–¥ 2" />
    </div>

    <button class="orderBtn" id="orderBtn" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

<script>
  const API_URL = "https://tg-miniapp-backend-production.up.railway.app";

  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const user = tg?.initDataUnsafe?.user || null;
  const initData = tg?.initData || "";

  const buyerText = user
    ? `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${user.first_name}${user.last_name ? " " + user.last_name : ""} (id ${user.id})`
    : "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: –ì–æ—Å—Ç—å (–Ω–µ –∏–∑ Telegram)";
  document.getElementById("buyerLine").textContent = buyerText;

  const PRODUCTS = [
    {
      id: 1,
      title: '–ö—Ä–∞—Å–Ω—ã–µ —Ä–æ–∑—ã "–ö–ª–∞—Å—Å–∏–∫–∞"',
      category: "–ö—Ä–∞—Å–Ω—ã–µ",
      price: 3500,
      popular: true,
      desc: "–ë—É–∫–µ—Ç –∏–∑ 11 —Å–≤–µ–∂–∏—Ö –∫—Ä–∞—Å–Ω—ã—Ö —Ä–æ–∑ ‚Äî —Å–∏–º–≤–æ–ª —Å—Ç—Ä–∞—Å—Ç–∏ –∏ –ª—é–±–≤–∏",
      images: ["https://images.unsplash.com/photo-1548095115-45697e1bd1b3?auto=format&fit=crop&w=1200&q=80"]
    },
    {
      id: 2,
      title: '–ë–µ–ª—ã–µ —Ä–æ–∑—ã "–ù–µ–∂–Ω–æ—Å—Ç—å"',
      category: "–ë–µ–ª—ã–µ",
      price: 3200,
      popular: true,
      desc: "–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –±—É–∫–µ—Ç –∏–∑ –±–µ–ª—ã—Ö —Ä–æ–∑ –¥–ª—è –æ—Å–æ–±–µ–Ω–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤",
      images: ["https://images.unsplash.com/photo-1509042239860-f550ce710b93?auto=format&fit=crop&w=1200&q=80"]
    },
    {
      id: 3,
      title: '–†–æ–∑–æ–≤—ã–µ —Ä–æ–∑—ã "–†–æ–º–∞–Ω—Ç–∏–∫–∞"',
      category: "–†–æ–∑–æ–≤—ã–µ",
      price: 2900,
      popular: true,
      desc: "–ù–µ–∂–Ω—ã–π –±—É–∫–µ—Ç –∏–∑ —Ä–æ–∑–æ–≤—ã—Ö —Ä–æ–∑ ‚Äî –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏–π",
      images: ["https://images.unsplash.com/photo-1444392061186-0e23080c310a?auto=format&fit=crop&w=1200&q=80"]
    }
  ];

  const cart = new Map(); // productId -> qty
  const app = document.getElementById("app");
  const cartCountEl = document.getElementById("cartCount");
  const cartTotalEl = document.getElementById("cartTotal");
  const orderBtn = document.getElementById("orderBtn");
  const addressInput = document.getElementById("addressInput");

  let activeTab = "–í—Å–µ";

  const tabs = [
    {label:"–í—Å–µ", emoji:"üåπ"},
    {label:"–ö—Ä–∞—Å–Ω—ã–µ", emoji:"üíñ"},
    {label:"–ë–µ–ª—ã–µ", emoji:"ü§ç"},
    {label:"–†–æ–∑–æ–≤—ã–µ", emoji:"üíó"},
    {label:"–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ", emoji:"‚≠ê"}
  ];

  function money(n){ return String(n); }
  function getQty(id){ return cart.get(id) || 0; }
  function setQty(id, qty){
    if (qty <= 0) cart.delete(id);
    else cart.set(id, qty);
    updateCartUI();
  }

  function filteredProducts(){
    if (activeTab === "–í—Å–µ") return PRODUCTS;
    if (activeTab === "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ") return PRODUCTS.filter(p=>p.popular);
    return PRODUCTS.filter(p=>p.category===activeTab);
  }

  function calcTotals(){
    let count = 0, total = 0;
    for (const p of PRODUCTS){
      const q = getQty(p.id);
      if (q>0){ count += q; total += q*p.price; }
    }
    return {count,total};
  }

  function updateCartUI(){
    const {count,total} = calcTotals();
    cartCountEl.textContent = count;
    cartTotalEl.textContent = money(total);
    orderBtn.disabled = count === 0;
  }

  function renderCatalog(){
    const items = filteredProducts();
    app.innerHTML = `<div class="tabs" id="tabs"></div><div class="grid" id="grid"></div>`;

    const tabsEl = document.getElementById("tabs");
    tabs.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tab" + (t.label===activeTab ? " active" : "");
      b.innerHTML = `<span>${t.emoji}</span> ${t.label}`;
      b.onclick = ()=>{ activeTab = t.label; renderCatalog(); };
      tabsEl.appendChild(b);
    });

    const grid = document.getElementById("grid");
    items.forEach(p=>{
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="imgWrap">
          <img src="${p.images[0]}" alt="">
          ${p.popular ? `<div class="badge">‚≠ê –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</div>` : ""}
        </div>
        <div class="cardBody">
          <p class="title">${p.title}</p>
          <p class="desc">${p.desc}</p>
          <div class="bottomRow">
            <div class="price">${money(p.price)} ‚ÇΩ</div>
            <button class="addBtn">+ –í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `;
      card.querySelector(".addBtn").onclick = (e)=>{
        e.stopPropagation();
        setQty(p.id, getQty(p.id)+1);
      };
      grid.appendChild(card);
    });
  }

  function buildOrderItems(){
    const items = [];
    for (const p of PRODUCTS){
      const q = getQty(p.id);
      if (q>0){
        items.push({ product_id: p.id, title: p.title, price: p.price, qty: q });
      }
    }
    return items;
  }

  async function sendOrder(){
    const {count} = calcTotals();
    if (count === 0) return;

    if (!tg || !user || !initData) {
      alert("–û—Ç–∫—Ä–æ–π mini-app –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.");
      return;
    }

    const address = (addressInput.value || "").trim();
    if (!address) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å.");
      return;
    }

    orderBtn.disabled = true;

    try{
      const r = await fetch(`${API_URL}/api/order`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          initData,
          items: buildOrderItems(),
          address_text: address
        })
      });

      const data = await r.json().catch(()=> ({}));
      if (!r.ok){
        alert("–û—à–∏–±–∫–∞: " + JSON.stringify(data));
        orderBtn.disabled = false;
        return;
      }

      cart.clear();
      updateCartUI();
      tg.showAlert(`–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ\nID: ${data.order_id}`);
    } catch(e){
      alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: " + e);
      orderBtn.disabled = false;
    }
  }

  document.getElementById("goHome").onclick = renderCatalog;
  document.getElementById("openCart").onclick = ()=>{
    const {count,total} = calcTotals();
    alert(count===0 ? "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è" : `–¢–æ–≤–∞—Ä–æ–≤: ${count}\n–°—É–º–º–∞: ${total} ‚ÇΩ`);
  };
  orderBtn.onclick = sendOrder;

  updateCartUI();
  renderCatalog();
</script>
</body>
</html>
