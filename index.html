<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>FlowerShop</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif}
    body{max-width:520px;margin:0 auto;padding:16px;background:linear-gradient(135deg,#fff9fb 0%,#f8f9fa 100%);padding-bottom:140px}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:16px}
    .title{font-size:22px;font-weight:800;color:#e83e8c;text-align:center;margin:8px 0 2px}
    .sub{color:#6c757d;text-align:center;margin-bottom:12px;font-size:13px}
    img{width:100%;height:220px;object-fit:cover;border-radius:10px;margin-bottom:12px}
    .h3{font-size:18px;font-weight:700;margin-bottom:6px;color:#2c3e50}
    .p{color:#7f8c8d;font-size:14px;line-height:1.5;margin-bottom:10px}
    .price{font-size:22px;font-weight:800;color:#e74c3c;margin:10px 0 14px}
    .section{font-weight:700;margin:12px 0 10px;color:#2c3e50}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .color{width:34px;height:34px;border-radius:50%;border:2px solid #ddd;cursor:pointer}
    .color.active{border-color:#333;box-shadow:0 0 0 2px #fff,0 0 0 4px #333}
    .chip{flex:1;min-width:110px;text-align:center;background:#f8f9fa;border:1px solid #e9ecef;border-radius:10px;padding:10px;cursor:pointer;font-size:13px}
    .chip.active{background:linear-gradient(135deg,#e83e8c,#9b59b6);color:#fff;border-color:#e83e8c}
    .opt{display:flex;align-items:center;gap:10px;background:#f8f9fa;border-radius:10px;padding:12px;border:2px solid transparent;cursor:pointer;margin-bottom:8px}
    .opt.active{border-color:#e83e8c;background:#fff0f5}
    .tag{font-weight:800;color:#e74c3c}
    input{width:100%;padding:12px;border:1px solid #ced4da;border-radius:10px}
    .basket{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:2px solid #f8d7da;box-shadow:0 -2px 10px rgba(0,0,0,.08);padding:14px}
    .total{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .total strong{font-size:24px;color:#e74c3c}
    .btn{width:100%;border:none;border-radius:12px;padding:16px;background:linear-gradient(135deg,#e83e8c,#9b59b6);color:#fff;font-size:16px;font-weight:800;cursor:pointer}
    .btn:disabled{background:#adb5bd;cursor:not-allowed}
    .toast{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#28a745;color:#fff;padding:10px 18px;border-radius:10px;z-index:9999}
    .toast.error{background:#dc3545}
    .spin{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid #f3f3f3;border-top:3px solid #fff;vertical-align:middle;margin-right:8px;animation:s 1s linear infinite}
    @keyframes s{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <div class="card">
    <div class="title">üíê –ö–∞—Ç–∞–ª–æ–≥ –±—É–∫–µ—Ç–æ–≤</div>
    <div class="sub">–û—Ç–∫—Ä–æ–π –∏–∑ Telegram ‚Äî –∏ –æ—Ç–ø—Ä–∞–≤—å –∑–∞–∫–∞–∑ –±–æ—Ç—É</div>
  </div>

  <div class="card">
    <img id="img" src="https://i.imgur.com/7Z1kZ4l.jpg" alt="–ë—É–∫–µ—Ç"/>
    <div class="h3">–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –±—É–∫–µ—Ç</div>
    <div class="p">–†–æ–∑—ã, –ª–∏–ª–∏–∏, —ç—É—Å—Ç–æ–º–∞ –≤ –Ω–µ–∂–Ω—ã—Ö —Ç–æ–Ω–∞—Ö. –ò–¥–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫.</div>
    <div class="price">‚ÇΩ <span id="basePrice">3500</span></div>

    <div class="section">üé® –¶–≤–µ—Ç</div>
    <div class="row" id="colors">
      <div class="color active" style="background:#e83e8c" data-color="#e83e8c"></div>
      <div class="color" style="background:#3498db" data-color="#3498db"></div>
      <div class="color" style="background:#2ecc71" data-color="#2ecc71"></div>
      <div class="color" style="background:#f39c12" data-color="#f39c12"></div>
    </div>

    <div class="section">üéÅ –î–æ–ø–æ–ª–Ω–µ–Ω–∏—è</div>
    <div class="row" id="addons">
      <div class="chip" data-name="üß∏ –ú–∏—à–∫–∞" data-price="1000">üß∏ –ú–∏—à–∫–∞ (+1000‚ÇΩ)</div>
      <div class="chip" data-name="üç¨ –ö–æ–Ω—Ñ–µ—Ç—ã" data-price="300">üç¨ –ö–æ–Ω—Ñ–µ—Ç—ã (+300‚ÇΩ)</div>
      <div class="chip" data-name="üç´ –®–æ–∫–æ–ª–∞–¥" data-price="500">üç´ –®–æ–∫–æ–ª–∞–¥ (+500‚ÇΩ)</div>
    </div>

    <div class="section">üöö –î–æ—Å—Ç–∞–≤–∫–∞</div>
    <div id="delivery">
      <div class="opt active" data-type="center" data-price="1500">–¶–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã <span class="tag">(1500‚ÇΩ)</span></div>
      <div class="opt" data-type="mkad" data-price="2000">–î–æ –ú–ö–ê–î <span class="tag">(2000‚ÇΩ)</span></div>
      <div class="opt" data-type="self" data-price="0">–°–∞–º–æ–≤—ã–≤–æ–∑ <span class="tag">(0‚ÇΩ)</span></div>
    </div>

    <div class="section">üè∑ –ü—Ä–æ–º–æ–∫–æ–¥</div>
    <input id="promo" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: flower2024" />
  </div>

  <div class="basket">
    <div class="total">
      <span>–ò—Ç–æ–≥–æ:</span>
      <strong>‚ÇΩ <span id="total">5000</span></strong>
    </div>
    <button class="btn" id="btn" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const basePrice = 3500;

    let selectedColor = "#e83e8c";
    let selectedDelivery = "center";
    let deliveryPrice = 1500;
    let promoCode = "";
    let addOns = []; // {name, price}

    function toast(msg, isErr=false){
      const t = document.createElement("div");
      t.className = "toast" + (isErr ? " error" : "");
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2200);
    }

    function calcTotal(){
      let total = basePrice + deliveryPrice + addOns.reduce((s,a)=>s+a.price,0);
      let discount = 0;
      const p = promoCode.toLowerCase();
      if (p === "flower2024") discount = total * 0.10;
      if (p === "newyear") discount = total * 0.15;
      total = Math.max(0, Math.round(total - discount));
      document.getElementById("total").textContent = total;
      return total;
    }

    document.getElementById("colors").addEventListener("click", (e)=>{
      const el = e.target.closest(".color");
      if(!el) return;
      document.querySelectorAll(".color").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      selectedColor = el.dataset.color;
      calcTotal();
    });

    document.getElementById("addons").addEventListener("click", (e)=>{
      const el = e.target.closest(".chip");
      if(!el) return;
      el.classList.toggle("active");
      const name = el.dataset.name;
      const price = parseInt(el.dataset.price,10);

      const idx = addOns.findIndex(x=>x.name===name && x.price===price);
      if(idx === -1) addOns.push({name, price});
      else addOns.splice(idx,1);

      calcTotal();
    });

    document.getElementById("delivery").addEventListener("click", (e)=>{
      const el = e.target.closest(".opt");
      if(!el) return;
      document.querySelectorAll(".opt").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      selectedDelivery = el.dataset.type;
      deliveryPrice = parseInt(el.dataset.price,10);
      calcTotal();
    });

    document.getElementById("promo").addEventListener("input", (e)=>{
      promoCode = (e.target.value || "").trim();
      calcTotal();
    });

    function checkout(){
      const btn = document.getElementById("btn");
      btn.disabled = true;
      btn.innerHTML = '<span class="spin"></span>–û—Ç–ø—Ä–∞–≤–∫–∞...';

      try{
        if(!tg) throw new Error("–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ Telegram (Telegram.WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ).");

        const total = calcTotal();

        const payload = {
          bouquet: "romantic",
          color: selectedColor,
          add_ons: addOns.map(a => `${a.name} (+${a.price}‚ÇΩ)`),
          total_price: total,
          promo_code: promoCode,
          delivery_type: selectedDelivery,
          delivery_price: deliveryPrice
        };

        tg.sendData(JSON.stringify(payload));
        setTimeout(()=>tg.close(), 700);
      }catch(err){
        console.error(err);
        toast("‚ùå " + err.message, true);
        btn.disabled = false;
        btn.textContent = "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑";
      }
    }

    // init
    document.getElementById("basePrice").textContent = basePrice;
    calcTotal();
  </script>
</body>
</html>
